<!DOCTYPE HTML >
<html>
<head>
<meta charset="utf-8">
<script type = "text/javascript">

///////////////////////////////////////////////////
// copied from FirmataConstants.h
// message command bytes (128-255/0x80-0xFF)

const DIGITAL_MESSAGE =         0x90; // send data for a digital port (collection of 8 pins)
const ANALOG_MESSAGE =          0xE0; // send data for an analog pin (or PWM)
const REPORT_ANALOG =           0xC0; // enable analog input by pin #
const REPORT_DIGITAL =          0xD0; // enable digital input by port pair
//
const SET_PIN_MODE =            0xF4; // set a pin to INPUT/OUTPUT/PWM/etc
const SET_DIGITAL_PIN_VALUE =   0xF5; // set value of an individual digital pin
//
const REPORT_VERSION =          0xF9; // report protocol version
const SYSTEM_RESET =            0xFF; // reset from MIDI
//
const START_SYSEX =             0xF0; // start a MIDI Sysex message
const END_SYSEX =               0xF7; // end a MIDI Sysex message

// extended command set using sysex (0-127/0x00-0x7F)
/* 0x00-0x0F reserved for user-defined commands */

const SERIAL_DATA =             0x60; // communicate with serial devices, including other boards
const ENCODER_DATA =            0x61; // reply with encoders current positions
const SERVO_CONFIG =            0x70; // set max angle, minPulse, maxPulse, freq
const STRING_DATA =             0x71; // a string message with 14-bits per char
const STEPPER_DATA =            0x72; // control a stepper motor
const ONEWIRE_DATA =            0x73; // send an OneWire read/write/reset/select/skip/search request
const SHIFT_DATA =              0x75; // a bitstream to/from a shift register
const I2C_REQUEST =             0x76; // send an I2C read/write request
const I2C_REPLY =               0x77; // a reply to an I2C read request
const I2C_CONFIG =              0x78; // config I2C settings such as delay times and power pins
const REPORT_FIRMWARE =         0x79; // report name and version of the firmware
const EXTENDED_ANALOG =         0x6F; // analog write (PWM, Servo, etc) to any pin
const PIN_STATE_QUERY =         0x6D; // ask for a pin's current mode and value
const PIN_STATE_RESPONSE =      0x6E; // reply with pin's current mode and value
const CAPABILITY_QUERY =        0x6B; // ask for supported modes and resolution of all pins
const CAPABILITY_RESPONSE =     0x6C; // reply with supported modes and resolution
const ANALOG_MAPPING_QUERY =    0x69; // ask for mapping of analog to pin numbers
const ANALOG_MAPPING_RESPONSE = 0x6A; // reply with mapping info
const SAMPLING_INTERVAL =       0x7A; // set the poll rate of the main loop
const SCHEDULER_DATA =          0x7B; // send a createtask/deletetask/addtotask/schedule/querytasks/querytask request to the scheduler
const SYSEX_NON_REALTIME =      0x7E; // MIDI Reserved for non-realtime messages
const SYSEX_REALTIME =          0x7F; // MIDI Reserved for realtime messages

// pin modes
const PIN_MODE_INPUT =          0x00; // same as INPUT defined in Arduino.h
const PIN_MODE_OUTPUT =         0x01; // same as OUTPUT defined in Arduino.h
const PIN_MODE_ANALOG =         0x02; // analog pin in analogInput mode
const PIN_MODE_PWM =            0x03; // digital pin in PWM output mode
const PIN_MODE_SERVO =          0x04; // digital pin in Servo output mode
const PIN_MODE_SHIFT =          0x05; // shiftIn/shiftOut mode
const PIN_MODE_I2C =            0x06; // pin included in I2C setup
const PIN_MODE_ONEWIRE =        0x07; // pin configured for 1-wire
const PIN_MODE_STEPPER =        0x08; // pin configured for stepper motor
const PIN_MODE_ENCODER =        0x09; // pin configured for rotary encoders
const PIN_MODE_SERIAL =         0x0A; // pin configured for serial communication
const PIN_MODE_PULLUP =         0x0B; // enable internal pull-up resistor for pin
const PIN_MODE_IGNORE =         0x7F; // pin configured to be ignored by digitalWrite and capabilityResponse

const TOTAL_PIN_MODES =         13;
///////////////////////////////////////////////////

var ws = undefined;
var gpios = 0;
var port = 0; //??

function start()
{
    console.log("Firmata-WebSocket demo running");

    if (!("WebSocket" in window))
    {
        alert("WebSocket NOT supported by your Browser!");
        return;
    }
}

function notConnected()
{
    console.log("not connected");
}

function digitalWrite(n, v)
{
    if (ws)
    {
        b = new Uint8Array(3);
        msg = 1 << n;
        if (v)
            gpios |= msg;
        else
            gpios &= ~msg;
        b[0] = DIGITAL_MESSAGE + port;
        b[1] = gpios & 0x7f;
        b[2] = (gpios >> 7) & 0x7f;
        ws.send(b);
        console.log("digitalWrite(" + n + ', ' + v + ') - gpio=0x' + gpios.toString(16));
    }
    else
        notConnected();
}

function digitalRead(n)
{
    if (ws)
    {
        b = new Uint8Array(2);
        b[0] = PIN_STATE_QUERY;
        b[1] = n;
        ws.send(b);
        console.log("ask for reporting digital");
    }
    else
        notConnected();
}

function firmataReceived(a)
{
    switch (a[0])
    {
    case REPORT_VERSION:
        console.log('reported device protocol version = ' + a[1] + '.' + a[2]);
        break;
    default:
        m = "Unhandled from firmata: len=" + a.byteLength + ": "
        for (var i = 0; i < a.byteLength; i++)
          m += ' 0x' + a[i].toString(16);
        console.log(m);
    }
}

function connect()
{
    console.log('connecting tp: ' + document.getElementById('hostname').value);
    ws = new WebSocket(document.getElementById('hostname').value);
    if (!ws)
    {
        alert("Cannot open WebSocket " + document.getElementById('hostname').value);
        return;
    }

    ws.onopen = function()
    {
        console.log('connected to server\n');
        // firmata-websocket makes a difference between command and text, if that matters
        ws.send("hello from ws");

        // request firmata version
        b = new Uint8Array(1);
        b[0] = REPORT_VERSION;
        ws.send(b);
    };

    ws.onmessage = async function(evt)
    {
        var len = evt.data.length;
        console.log('type=' + typeof(evt.data));
        if (typeof(evt.data) == 'string') // ?? (evt.data instanceof String)
        {
            console.log('receive text event len=' + evt.data.length + ': "' + evt.data + '"\n');
        }
        else if (evt.data instanceof Blob)
        {
            firmataReceived(new Uint8Array(await evt.data.arrayBuffer()));
        }
        else
        {
            console.log('receive unknown event ? (type=' + typeof(evt.data) + ')');
        }
        //ws.send(evt.data); // echo
    };

    ws.onclose = function()
    {
        console.log('ws closed\n');
        ws = undefined;
    };

    ws.onerror = function()
    {
        alert('No connection to ' + document.getElementById('hostname').value);
    }
}

function disconnect()
{
    console.log('disconnect: ' + document.getElementById('hostname').value);
    ws = undefined;
}

</script>
</head>

<body onload="start()">

<textarea id="hostname" rows="1" cols="64">ws://firmata.local:3031/this-text-is/parsable-in-sketch</textarea>
<br>
<button onclick="connect()">Connect</button>
<button onclick="disconnect()">Disconnect</button>
<br>
<button onclick="digitalWrite(0,0)">digitalWrite(0,0)</button>
<button onclick="digitalWrite(0,1)">digitalWrite(0,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(0)</button>
<br>
<button onclick="digitalWrite(1,0)">digitalWrite(1,0)</button>
<button onclick="digitalWrite(1,1)">digitalWrite(1,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(1)</button>
<br>
<button onclick="digitalWrite(2,0)">digitalWrite(2,0)</button>
<button onclick="digitalWrite(2,1)">digitalWrite(2,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(2)</button>
<br>
<button onclick="digitalWrite(3,0)">digitalWrite(3,0)</button>
<button onclick="digitalWrite(3,1)">digitalWrite(3,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(3)</button>
<br>
<button onclick="digitalWrite(4,0)">digitalWrite(4,0)</button>
<button onclick="digitalWrite(4,1)">digitalWrite(4,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(4)</button>
<br>
<button onclick="digitalWrite(5,0)">digitalWrite(5,0)</button>
<button onclick="digitalWrite(5,1)">digitalWrite(5,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(5)</button>
<br>
<button onclick="digitalWrite(6,0)">digitalWrite(6,0)</button>
<button onclick="digitalWrite(6,1)">digitalWrite(6,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(6)</button>
<br>
<button onclick="digitalWrite(7,0)">digitalWrite(7,0)</button>
<button onclick="digitalWrite(7,1)">digitalWrite(7,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(7)</button>
<br>
<button onclick="digitalWrite(8,0)">digitalWrite(8,0)</button>
<button onclick="digitalWrite(8,1)">digitalWrite(8,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(8)</button>
<br>
<button onclick="digitalWrite(9,0)">digitalWrite(9,0)</button>
<button onclick="digitalWrite(9,1)">digitalWrite(9,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(9)</button>
<br>
<button onclick="digitalWrite(10,0)">digitalWrite(10,0)</button>
<button onclick="digitalWrite(10,1)">digitalWrite(10,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(10)</button>
<br>
<button onclick="digitalWrite(11,0)">digitalWrite(11,0)</button>
<button onclick="digitalWrite(11,1)">digitalWrite(11,1)</button>
<button id="dr2" onclick="digitalRead(2)">digitalRead(11)</button>

</body>
</html>
